<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Segment & Sub-segment Matching with Final Outputs</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
        background: #f4f7f8;
        color: #333;
      }
      h1,
      h2 {
        color: #004d40;
      }
      .input-section {
        max-width: 900px;
        margin-bottom: 30px;
      }
      textarea {
        width: 100%;
        height: 100px;
        padding: 12px;
        font-size: 1em;
        border-radius: 8px;
        border: 1px solid #ccc;
        resize: vertical;
        box-sizing: border-box;
      }
      button {
        margin-top: 10px;
        background-color: #004d40;
        color: white;
        padding: 10px 25px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s ease;
      }
      button:hover {
        background-color: #00695c;
      }
      .input-list,
      .final-output {
        background: white;
        border-radius: 10px;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-width: 900px;
        margin-bottom: 40px;
      }
      ul {
        padding-left: 20px;
      }
      ul li {
        margin-bottom: 6px;
        padding: 3px 6px;
        border-radius: 6px;
        font-weight: 600;
      }
      .highlight-name {
        font-weight: 700;
      }
      /* Status colors */
      .mapped {
        background-color: #c8f7c5; /* green */
        color: #246b24;
      }
      .renamed {
        background-color: #ffddb3; /* orange */
        color: #b26900;
      }
      .remap {
        background-color: #c3d9f9; /* blue */
        color: #1a3e8c;
      }
      .found-description {
        color: #555;
        font-style: italic;
        font-weight: 500;
        margin-left: 0.6em;
      }
      table {
        border-collapse: collapse;
        width: 900px;
        max-width: 100%;
        margin-bottom: 40px;
      }
      th,
      td {
        padding: 8px 10px;
        border: 1px solid #ddd;
        word-wrap: break-word;
      }
      th {
        background-color: #004d40;
        color: white;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1>Segment & Sub-segment Matching with Separate Final Outputs</h1>

    <div class="input-section">
      <textarea
        id="userInput"
        placeholder="Paste your inputs here, comma separated"
      ></textarea>
      <button id="processButton">Match Segments & Sub-segments</button>
    </div>

    <h2>Match Results</h2>
    <div class="input-list" id="inputList"></div>

    <h2>Final Output - Sub-segments</h2>
    <div class="final-output" id="finalSubSegmentOutput"></div>

    <h2>Final Output - Segments</h2>
    <div class="final-output" id="finalSegmentOutput"></div>

    <h2>Segments Table</h2>
    <table id="segmentsTable" aria-label="Segments Table">
      <thead>
        <tr>
          <th>Segment</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Enterprise Digital Natives</td>
          <td>New Mapped to “Enterprise Commercial” Summary Segment</td>
        </tr>
        <tr>
          <td>Majors Growth Commercial</td>
          <td>New Mapped to “Enterprise Commercial” Summary Segment</td>
        </tr>
        <tr>
          <td>Majors Growth Public Sector</td>
          <td>New Mapped to “Enterprise Public Sector” Summary Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - SMB Commercial</td>
          <td>New Mapped to “SME&amp;C Commercial” Summary Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - SMB Public Sector</td>
          <td>New Mapped to “SME&amp;C Public Sector” Summary Segment</td>
        </tr>
        <tr>
          <td>Major Commercial</td>
          <td>Renamed to “Upper Majors Commercial”</td>
        </tr>
        <tr>
          <td>Major Public Sector</td>
          <td>Renamed to “Upper Majors Public Sector"</td>
        </tr>
        <tr>
          <td>Small, Medium &amp; Corporate Commercial</td>
          <td>Renamed to “SME&amp;C - Corporate Commercial"</td>
        </tr>
        <tr>
          <td>Small, Medium &amp; Corporate Public Sector</td>
          <td>Renamed to “SME&amp;C - Corporate Public Sector"</td>
        </tr>
      </tbody>
    </table>

    <h2>Sub-segments Table</h2>
    <table id="subSegmentsTable" aria-label="Sub-segments Table">
      <thead>
        <tr>
          <th>Sub-segment</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Digital Natives</td>
          <td>New. Mapped to “Enterprise Digital Natives” Segment</td>
        </tr>
        <tr>
          <td>Majors Growth - Commercial</td>
          <td>New. Mapped to “Majors Growth Commercial” Segment</td>
        </tr>
        <tr>
          <td>Majors Growth - Public Sector</td>
          <td>New. Mapped to “Majors Growth Public Sector” Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - Corporate K14</td>
          <td>New. Mapped to “SME&amp;C - Corporate Public Sector” Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - Corporate TSI</td>
          <td>New. Mapped to “SME&amp;C - Corporate Commercial” Segment</td>
        </tr>
        <tr>
          <td>Major - Commercial Other</td>
          <td>Renamed to "Upper Majors - Commercial"</td>
        </tr>
        <tr>
          <td>Major - Education</td>
          <td>Renamed to “Upper Majors - Education”</td>
        </tr>
        <tr>
          <td>Major - Federal Government</td>
          <td>Renamed to “Upper Majors - Federal Government”</td>
        </tr>
        <tr>
          <td>Major - Government Other</td>
          <td>Renamed to “Upper Majors - Government”</td>
        </tr>
        <tr>
          <td>SM&amp;C Commercial - Corporate</td>
          <td>Renamed to "SME&amp;C - Corporate Commercial"</td>
        </tr>
        <tr>
          <td>SM&amp;C Commercial - SMB</td>
          <td>Renamed to "SME&amp;C - SMB Commercial"</td>
        </tr>
        <tr>
          <td>SM&amp;C Commercial - SMB Default</td>
          <td>Renamed to "SME&amp;C Commercial - SMB Default"</td>
        </tr>
        <tr>
          <td>SM&amp;C Education - Corporate</td>
          <td>Renamed to "SME&amp;C - Corporate Education"</td>
        </tr>
        <tr>
          <td>SM&amp;C Education - SMB</td>
          <td>Renamed to "SME&amp;C - SMB Education"</td>
        </tr>
        <tr>
          <td>SM&amp;C Government - Corporate</td>
          <td>Renamed to "SME&amp;C - Corporate Government"</td>
        </tr>
        <tr>
          <td>SM&amp;C Government - SMB</td>
          <td>Renamed to "SME&amp;C - SMB Government"</td>
        </tr>
        <tr>
          <td>Strategic - Commercial Other</td>
          <td>Renamed to "Strategic - Commercial "</td>
        </tr>
        <tr>
          <td>Major - Health</td>
          <td>Deleted</td>
        </tr>
        <tr>
          <td>Major - State &amp; Local Governments</td>
          <td>Deleted</td>
        </tr>
        <tr>
          <td>Strategic - Health</td>
          <td>Deleted</td>
        </tr>
        <tr>
          <td>SME&amp;C Commercial – SMB Default</td>
          <td>Remap to SME&amp;C - SMB Commercial Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - SMB Commercial</td>
          <td>Remap to SME&amp;C - SMB Commercial Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - SMB Education</td>
          <td>Remap to SME&amp;C - SMB Public Sector Segment</td>
        </tr>
        <tr>
          <td>SME&amp;C - SMB Government</td>
          <td>Remap to SME&amp;C - SMB Public Sector Segment</td>
        </tr>
      </tbody>
    </table>

    <script>
      function decodeHtmlEntities(text) {
        const txt = document.createElement("textarea");
        txt.innerHTML = text;
        return txt.value;
      }

      function normalizeText(text) {
        if (!text) return "";
        return decodeHtmlEntities(text)
          .replace(/[-–—]/g, "-")
          .trim()
          .toLowerCase();
      }

      function extractInParenthesesOrOriginal(text) {
        const matches = [...text.matchAll(/\(([^)]+)\)/g)];
        return matches.length
          ? matches[matches.length - 1][1].trim()
          : text.trim();
      }

      function extractTextInQuotes(text) {
        const match = text.match(/[“"”](.*?)[”"]/);
        return match ? match[1].trim() : null;
      }

      function clearHighlights(tbody) {
        for (const row of tbody.rows) {
          row.classList.remove("highlight-name", "mapped", "renamed", "remap");
        }
      }

      function getStatus(description) {
        const descLower = description.toLowerCase();
        if (descLower.includes("mapped"))
          return { className: "mapped", type: "Mapped" };
        if (descLower.includes("renamed"))
          return { className: "renamed", type: "Renamed" };
        if (descLower.includes("remap"))
          return { className: "remap", type: "Remap" };
        return { className: "", type: "Unknown" };
      }

      function findRemapTargetName(remapRow, data) {
        const desc = remapRow.description.toLowerCase();
        const remapIdx = desc.indexOf("remap to");
        if (remapIdx === -1) return null;
        let targetText = remapRow.description.slice(remapIdx + 8).trim();
        targetText = targetText.replace(/[.,]$/, "").trim();
        const normTarget = normalizeText(targetText);
        const renamedRow = data.find(
          (s) =>
            s.status.type === "Renamed" &&
            normalizeText(s.description).includes(normTarget)
        );
        return renamedRow ? renamedRow.nameOriginal : null;
      }

      function processInput() {
        const rawInput = document.getElementById("userInput").value.trim();
        const inputListContainer = document.getElementById("inputList");
        const finalSubSegOutput = document.getElementById(
          "finalSubSegmentOutput"
        );
        const finalSegOutput = document.getElementById("finalSegmentOutput");
        const segmentsBody =
          document.getElementById("segmentsTable").tBodies[0];
        const subSegmentsBody =
          document.getElementById("subSegmentsTable").tBodies[0];

        inputListContainer.innerHTML = "";
        finalSubSegOutput.innerHTML = "";
        finalSegOutput.innerHTML = "";
        clearHighlights(subSegmentsBody);
        clearHighlights(segmentsBody);

        if (!rawInput) {
          inputListContainer.innerHTML = "<p>No input provided.</p>";
          return;
        }

        const rawItems = rawInput.split(",").map((i) => i.trim());
        const extractedValues = rawItems.map(extractInParenthesesOrOriginal);

        // Prepare segment data
        const segmentsData = Array.from(segmentsBody.rows).map((row) => {
          const nameOriginal = row.cells[0].textContent;
          const name = normalizeText(nameOriginal);
          const description = row.cells[1].textContent;
          const descriptionQuote = extractTextInQuotes(description);
          const status = getStatus(description);
          return {
            rowElem: row,
            name,
            nameOriginal,
            description,
            descriptionQuote,
            status,
          };
        });

        // Prepare sub-segment data
        const subSegmentsData = Array.from(subSegmentsBody.rows).map((row) => {
          const nameOriginal = row.cells[0].textContent;
          const name = normalizeText(nameOriginal);
          const description = row.cells[1].textContent;
          const descriptionQuote = extractTextInQuotes(description);
          const status = getStatus(description);
          return {
            rowElem: row,
            name,
            nameOriginal,
            description,
            descriptionQuote,
            status,
          };
        });

        const resultUl = document.createElement("ul");
        finalSubSegOutput.innerHTML = "";
        finalSegOutput.innerHTML = "";

        // Track final outputs by type
        const finalSubSegResults = [];
        const finalSegResults = [];

        for (const val of extractedValues) {
          const normVal = normalizeText(val);

          // Try matching sub-segment first
          let matchSub = subSegmentsData.find((s) => s.name === normVal);

          if (!matchSub) {
            matchSub = subSegmentsData.find(
              (s) =>
                s.descriptionQuote &&
                normalizeText(s.descriptionQuote) === normVal
            );
          }

          // Try matching segment
          let matchSeg = segmentsData.find((s) => s.name === normVal);

          if (!matchSeg) {
            matchSeg = segmentsData.find(
              (s) =>
                s.descriptionQuote &&
                normalizeText(s.descriptionQuote) === normVal
            );
          }

          const li = document.createElement("li");
          li.textContent = val;

          if (matchSub) {
            matchSub.rowElem.classList.add(
              "highlight-name",
              matchSub.status.className
            );
            li.classList.add(matchSub.status.className);

            const descSpan = document.createElement("span");
            descSpan.classList.add("found-description");
            descSpan.textContent = " (Sub-segment) – " + matchSub.description;
            li.appendChild(descSpan);
          }

          if (matchSeg) {
            matchSeg.rowElem.classList.add(
              "highlight-name",
              matchSeg.status.className
            );

            const descSpan = document.createElement("span");
            descSpan.classList.add("found-description");
            descSpan.textContent = " (Segment) – " + matchSeg.description;
            li.appendChild(descSpan);
          }

          if (!matchSub && !matchSeg) {
            li.textContent += " – No match found";
          }

          resultUl.appendChild(li);

          // Build final sub-segment output
          if (matchSub) {
            let finalText = "";
            switch (matchSub.status.type) {
              case "Mapped":
                finalText = matchSub.nameOriginal;
                break;
              case "Renamed":
                finalText = matchSub.nameOriginal; // as requested
                break;
              case "Remap":
                const targetName = findRemapTargetName(
                  matchSub,
                  subSegmentsData
                );
                finalText = targetName || val;
                break;
              default:
                finalText = val;
            }
            finalSubSegResults.push(finalText);
          } else {
            finalSubSegResults.push(val);
          }

          // Build final segment output
          if (matchSeg) {
            let finalText = "";
            switch (matchSeg.status.type) {
              case "Mapped":
                finalText = matchSeg.nameOriginal;
                break;
              case "Renamed":
                finalText = matchSeg.nameOriginal; // use segment column name
                break;
              case "Remap":
                const targetName = findRemapTargetName(matchSeg, segmentsData);
                finalText = targetName || val;
                break;
              default:
                finalText = val;
            }
            finalSegResults.push(finalText);
          } else {
            finalSegResults.push(val);
          }
        }

        inputListContainer.appendChild(resultUl);

        // Append only final results as plain list items
        const subUl = document.createElement("ul");
        finalSubSegResults.forEach((txt) => {
          const li = document.createElement("li");
          li.textContent = txt;
          subUl.appendChild(li);
        });
        finalSubSegOutput.appendChild(subUl);

        const segUl = document.createElement("ul");
        finalSegResults.forEach((txt) => {
          const li = document.createElement("li");
          li.textContent = txt;
          segUl.appendChild(li);
        });
        finalSegOutput.appendChild(segUl);
      }

      document
        .getElementById("processButton")
        .addEventListener("click", processInput);
    </script>
  </body>
</html>
